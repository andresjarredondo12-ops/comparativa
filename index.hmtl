<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comparador Profesional de Documentos</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
    font-family: 'Segoe UI', sans-serif;
    background: #eef2f7;
    margin: 0;
    padding: 20px;
}
.container {
    max-width: 1200px;
    margin: auto;
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
}
h1 {
    text-align: center;
    margin-bottom: 25px;
}
.upload-section {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}
input[type="file"] {
    flex: 1;
}
button {
    padding: 10px 18px;
    background: #2563eb;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
}
button:hover {
    background: #1e40af;
}
.result-box {
    margin-top: 20px;
    padding: 15px;
    background: #f9fafb;
    border-radius: 8px;
}
.success { color: #16a34a; font-weight: bold; }
.error { color: #dc2626; font-weight: bold; }
.diff-added { background: #dcfce7; }
.diff-removed { background: #fee2e2; }
.diff-container {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}
.text-box {
    flex: 1;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 6px;
    max-height: 400px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 13px;
}
.summary {
    background: #eff6ff;
    padding: 10px;
    border-radius: 6px;
    margin-top: 15px;
}
.loading {
    font-weight: bold;
    color: #444;
}
</style>
</head>
<body>

<div class="container">
    <h1>Comparador Profesional de Documentos</h1>

    <div class="upload-section">
        <input type="file" id="file1" accept="image/*,.pdf">
        <input type="file" id="file2" accept="image/*,.pdf">
    </div>

    <button onclick="compareFiles()">Comparar</button>
    <button onclick="exportPDF()">Exportar Reporte PDF</button>

    <div id="status" class="loading"></div>

    <div id="result" class="result-box"></div>
    <div id="summary" class="summary"></div>

    <div class="diff-container">
        <div id="text1" class="text-box"></div>
        <div id="text2" class="text-box"></div>
    </div>
</div>

<script>

let globalReport = "";

async function extractTextFromImage(file) {
    const { data: { text } } = await Tesseract.recognize(file, 'spa');
    return text;
}

async function extractTextFromPDF(file) {
    const pdfData = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: pdfData}).promise;
    let fullText = '';

    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str);
        fullText += strings.join(' ') + '\n';
    }
    return fullText;
}

async function extractText(file) {
    if (file.type === "application/pdf") {
        return await extractTextFromPDF(file);
    } else {
        return await extractTextFromImage(file);
    }
}

function extractAccountNumber(text) {
    const regex = /(cuenta|c\/c|cta|nro cuenta|número de cuenta)[^\d]{0,10}(\d{6,})/gi;
    const match = regex.exec(text);
    return match ? match[2] : null;
}

function extractRemitoNumber(text) {
    const regex = /(remito|nro remito|número remito)[^\d]{0,10}(\d{6,})/gi;
    const match = regex.exec(text);
    return match ? match[2] : null;
}

function compareLast5Digits(a, b) {
    if (!a || !b) return false;
    return a.slice(-5) === b.slice(-5);
}

function diffTexts(text1, text2) {
    const lines1 = text1.split("\n");
    const lines2 = text2.split("\n");

    let html1 = "";
    let html2 = "";
    let differences = 0;

    const maxLength = Math.max(lines1.length, lines2.length);

    for (let i = 0; i < maxLength; i++) {
        if (lines1[i] !== lines2[i]) {
            differences++;
            html1 += `<div class="diff-removed">${lines1[i] || ""}</div>`;
            html2 += `<div class="diff-added">${lines2[i] || ""}</div>`;
        } else {
            html1 += `<div>${lines1[i] || ""}</div>`;
            html2 += `<div>${lines2[i] || ""}</div>`;
        }
    }

    return { html1, html2, differences };
}

async function compareFiles() {
    const file1 = document.getElementById("file1").files[0];
    const file2 = document.getElementById("file2").files[0];
    const status = document.getElementById("status");
    const resultDiv = document.getElementById("result");
    const summaryDiv = document.getElementById("summary");

    if (!file1 || !file2) {
        alert("Debes subir ambos archivos.");
        return;
    }

    status.innerText = "Procesando documentos...";
    resultDiv.innerHTML = "";
    summaryDiv.innerHTML = "";

    const text1 = await extractText(file1);
    const text2 = await extractText(file2);

    const account1 = extractAccountNumber(text1);
    const account2 = extractAccountNumber(text2);

    const remito1 = extractRemitoNumber(text1);
    const remito2 = extractRemitoNumber(text2);

    let report = "REPORTE DE COMPARACIÓN\n\n";

    if (account1 && account2 && account1 === account2) {
        resultDiv.innerHTML += `<p class="success">✔ Número de cuenta coincide: ${account1}</p>`;
        report += `Cuenta coincide: ${account1}\n`;
    } else {
        resultDiv.innerHTML += `<p class="error">✘ Número de cuenta diferente</p>`;
        report += `Cuenta diferente\n`;
    }

    if (compareLast5Digits(remito1, remito2)) {
        resultDiv.innerHTML += `<p class="success">✔ Últimos 5 dígitos del remito coinciden</p>`;
        report += `Remito coincide últimos 5 dígitos\n`;
    } else {
        resultDiv.innerHTML += `<p class="error">✘ Remito NO coincide</p>`;
        report += `Remito diferente\n`;
    }

    const diff = diffTexts(text1, text2);
    document.getElementById("text1").innerHTML = diff.html1;
    document.getElementById("text2").innerHTML = diff.html2;

    summaryDiv.innerHTML = `Diferencias detectadas en ${diff.differences} líneas.`;

    report += `Diferencias en líneas: ${diff.differences}\n`;

    globalReport = report;

    status.innerText = "Proceso finalizado.";
}

function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text(globalReport, 10, 10);
    doc.save("reporte_comparacion.pdf");
}

</script>

</body>
</html>
